# Hướng dẫn tích hợp API Condotel

## Cấu hình môi trường

Tạo file `.env` ở thư mục root với nội dung:

```env
REACT_APP_API_URL=http://localhost:5000/api
```

Thay đổi URL phù hợp với backend API của bạn.

## Cấu trúc API

### Base URL
```
http://localhost:5000/api/condotel
```

### Endpoints

#### 1. Lấy tất cả condotels
```
GET /api/condotel
Response: CondotelDTO[]
```

#### 2. Lấy condotel theo ID
```
GET /api/condotel/{id}
Response: CondotelDetailDTO
```

#### 3. Tạo condotel mới
```
POST /api/condotel
Body: CondotelDetailDTO
Response: CondotelDetailDTO
```

#### 4. Cập nhật condotel
```
PUT /api/condotel/{id}
Body: CondotelDetailDTO
Response: CondotelDetailDTO
```

#### 5. Xóa condotel
```
DELETE /api/condotel/{id}
Response: void
```

## Interface TypeScript

### CondotelDTO (List View)
```typescript
{
  condotelId: number;
  name: string;
  pricePerNight: number;
  beds: number;
  bathrooms: number;
  status: string;
  thumbnailUrl?: string;
  resortName?: string;
  hostName?: string;
}
```

### CondotelDetailDTO (Detail View)
```typescript
{
  condotelId: number;
  hostId: number;
  resortId?: number;
  name: string;
  description?: string;
  pricePerNight: number;
  beds: number;
  bathrooms: number;
  status: string;
  
  // Liên kết 1-n
  images?: ImageDTO[];
  prices?: PriceDTO[];
  details?: DetailDTO[];
  
  // Liên kết n-n
  amenityIds?: number[];
  utilityIds?: number[];
}
```

### CreateCondotelDTO (For Creating)
Same as CondotelDetailDTO but without condotelId

### ImageDTO
```typescript
{
  imageId: number;
  imageUrl: string;
  caption?: string;
}
```

### PriceDTO
```typescript
{
  priceId: number;
  startDate: string; // DateOnly
  endDate: string;
  basePrice: number;
  priceType: string;
  description: string;
}
```

### DetailDTO
```typescript
{
  buildingName?: string;
  roomNumber?: string;
  beds: number;
  bathrooms: number;
  safetyFeatures?: string;
  hygieneStandards?: string;
}
```

## Cách sử dụng trong Component

### Import API
```typescript
import condotelAPI, { CondotelDTO, CondotelDetailDTO } from "api/condotel";
```

### Ví dụ: Tạo mới condotel
```typescript
import { CreateCondotelDTO } from "api/condotel";

const handleSubmit = async () => {
  const condotelData: CreateCondotelDTO = {
    hostId: 1, // ID của host
    resortId: 1, // Optional: ID của resort
    name: "Condotel Luxury Saigon",
    description: "Luxury condotel với view thành phố tuyệt đẹp",
    pricePerNight: 2000000,
    beds: 2,
    bathrooms: 2,
    status: "Available",
    
    // Images
    images: [
      {
        imageId: 0, // Will be generated by backend
        imageUrl: "https://example.com/image1.jpg",
        caption: "Phòng ngủ"
      }
    ],
    
    // Prices
    prices: [
      {
        priceId: 0,
        startDate: "2024-01-01",
        endDate: "2024-12-31",
        basePrice: 2000000,
        priceType: "Regular",
        description: "Giá cơ bản"
      }
    ],
    
    // Details
    details: [
      {
        buildingName: "Tòa A",
        roomNumber: "301",
        beds: 2,
        bathrooms: 2,
        safetyFeatures: "Báo cháy, camera",
        hygieneStandards: "Tiêu chuẩn 5 sao"
      }
    ],
    
    // Amenities và Utilities (IDs)
    amenityIds: [1, 2, 3], // IDs của amenities
    utilityIds: [1, 2, 4, 5], // IDs của utilities
  };

  try {
    const result = await condotelAPI.create(condotelData);
    console.log("Created:", result);
    // Navigate to next page or show success message
  } catch (error) {
    console.error("Error creating condotel:", error);
  }
};
```

### Ví dụ: Lấy danh sách condotels
```typescript
const [condotels, setCondotels] = useState<CondotelDTO[]>([]);

useEffect(() => {
  const fetchCondotels = async () => {
    try {
      const data = await condotelAPI.getAll();
      setCondotels(data);
    } catch (error) {
      console.error("Error fetching condotels:", error);
    }
  };

  fetchCondotels();
}, []);
```

### Ví dụ: Cập nhật condotel
```typescript
const handleUpdate = async (id: number, data: CondotelDetailDTO) => {
  try {
    const updated = await condotelAPI.update(id, data);
    console.log("Updated:", updated);
  } catch (error) {
    console.error("Error updating condotel:", error);
  }
};
```

### Ví dụ: Xóa condotel
```typescript
const handleDelete = async (id: number) => {
  try {
    await condotelAPI.delete(id);
    console.log("Deleted successfully");
    // Refresh list or redirect
  } catch (error) {
    console.error("Error deleting condotel:", error);
  }
};
```

## Tích hợp vào Form

### Lưu amenities vào state

Trong component PageAddListing4, bạn cần:

1. Import useState và useEffect
2. Tạo state để lưu amenities được chọn
3. Update state khi checkbox thay đổi
4. Gửi dữ liệu lên backend khi submit

```typescript
import { useState } from "react";

const PageAddListing4: FC<PageAddListing4Props> = () => {
  const [selectedAmenities, setSelectedAmenities] = useState<string[]>([]);

  const handleAmenityChange = (amenityName: string, isChecked: boolean) => {
    if (isChecked) {
      setSelectedAmenities([...selectedAmenities, amenityName]);
    } else {
      setSelectedAmenities(selectedAmenities.filter(a => a !== amenityName));
    }
  };

  // Sử dụng với Checkbox component
  // <Checkbox 
  //   label="Wifi" 
  //   name="Wifi" 
  //   onChange={(e) => handleAmenityChange("Wifi", e.target.checked)}
  // />

  return (
    // ... component JSX
  );
};
```

## Checklist Backend

Đảm bảo backend của bạn có:

- ✅ CORS enabled cho frontend domain
- ✅ JWT authentication (nếu cần)
- ✅ Validation cho CondotelDetailDTO
- ✅ Error handling
- ✅ Database migrations
- ✅ Logging

### ⚠️ Lưu ý về Create Action

Backend hiện tại có vấn đề nhỏ ở Create action:

```csharp
[HttpPost]
public ActionResult Create([FromBody] CondotelDetailDTO condotelDto)
{
    if (condotelDto == null) return BadRequest("Invalid condotel data");
    var created = _condotelService.CreateCondotel(condotelDto);
    return CreatedAtAction(nameof(GetById),
        new { id = condotelDto.CondotelId }, // ❌ condotelId chưa có giá trị
        created);
}
```

**Giải pháp 1 (Khuyến nghị)**: Sửa backend để lấy ID từ created object:

```csharp
[HttpPost]
public ActionResult Create([FromBody] CondotelDetailDTO condotelDto)
{
    if (condotelDto == null) return BadRequest("Invalid condotel data");
    var created = _condotelService.CreateCondotel(condotelDto);
    return CreatedAtAction(nameof(GetById),
        new { id = created.CondotelId }, // ✅ Lấy từ created object
        created);
}
```

**Giải pháp 2**: Nếu không thể sửa backend ngay, frontend sẽ gửi với `condotelId: 0`

## Cấu trúc DTO mong đợi từ Backend

Backend controller của bạn đã đúng! Đảm bảo:

```csharp
// CondotelDTO
public class CondotelDTO
{
    public int? CondotelId { get; set; }
    public string Name { get; set; }
    public string Address { get; set; }
    public string City { get; set; }
    public string Country { get; set; }
    public string Description { get; set; }
    public int? Acreage { get; set; }
    public int? Guests { get; set; }
    public int? Bedroom { get; set; }
    public int? Beds { get; set; }
    public int? Bathroom { get; set; }
    public int? Kitchen { get; set; }
    public List<string> Amenities { get; set; }
    public List<string> Images { get; set; }
    public decimal? Price { get; set; }
    public double? Latitude { get; set; }
    public double? Longitude { get; set; }
}

// CondotelDetailDTO extends CondotelDTO
public class CondotelDetailDTO : CondotelDTO
{
    public DateTime? CreatedAt { get; set; }
    public DateTime? UpdatedAt { get; set; }
    public string Status { get; set; }
    public int? OwnerId { get; set; }
}
```

## Testing

Test API bằng Postman hoặc curl:

```bash
# GET all condotels
curl http://localhost:5000/api/condotel

# GET by ID
curl http://localhost:5000/api/condotel/1

# POST create
curl -X POST http://localhost:5000/api/condotel \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Test Condotel",
    "address": "123 Main St",
    "city": "Ho Chi Minh",
    "country": "Vietnam",
    "amenities": ["Wifi", "Pool"]
  }'

# PUT update
curl -X PUT http://localhost:5000/api/condotel/1 \
  -H "Content-Type: application/json" \
  -d '{
    "condotelId": 1,
    "name": "Updated Condotel",
    "address": "456 Main St",
    "city": "Ho Chi Minh",
    "country": "Vietnam"
  }'

# DELETE
curl -X DELETE http://localhost:5000/api/condotel/1
```
